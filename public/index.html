<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tapestry — Collaborative Knowledge Curation</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div class="login-card">
      <h1>Tapestry</h1>
      <p class="subtitle">Collaborative knowledge curation</p>

      <label>Your name</label>
      <input type="text" id="login-name" placeholder="Enter your name" autocomplete="off">

      <label>Room</label>
      <div class="room-list" id="room-list">
        <div style="font-size: 13px; color: var(--text-muted); padding: 8px;">Loading rooms...</div>
      </div>

      <span class="create-room-toggle hidden" id="create-room-toggle">+ Create new room</span>
      <div class="create-room-row" id="create-room-row">
        <input type="text" id="new-room-name" placeholder="Room name">
        <input type="number" id="new-room-duration" placeholder="Minutes" min="1" max="120" style="width: 80px;">
        <button id="create-room-btn">Create</button>
      </div>

      <button id="join-btn" disabled>Join Room</button>
    </div>
  </div>

  <!-- ADMIN CONTROL STRIP -->
  <div id="admin-control-strip" class="admin-control-strip hidden">
    <div class="control-item admin-badge">
      <span class="admin-label">Admin</span>
    </div>
    <div class="control-separator"></div>
    <div class="control-item">
      <span class="control-label">Room:</span>
      <select id="room-state-select" class="control-select state-select">
        <option value="normal">normal</option>
        <option value="in-progress">in progress</option>
        <option value="posttest">posttest</option>
        <option value="closed">closed</option>
      </select>
    </div>
    <div class="control-separator"></div>
    <div class="control-item">
      <button id="timer-visibility-btn" class="control-icon-btn" title="Toggle timer visibility for all users">&#9201;</button>
      <button id="timer-display" class="control-btn timer-btn" title="Click: set duration. Right-click: start/pause.">
        <span id="timer-text">--:--</span>
      </button>
    </div>
    <div class="control-separator"></div>
    <div class="control-item">
      <span class="control-label">ESM:</span>
      <button id="esm-toggle-btn" class="control-btn toggle-btn" data-enabled="false">
        <span class="toggle-indicator"></span>
        <span id="esm-toggle-text">OFF</span>
      </button>
    </div>
    <div class="control-separator"></div>
    <button id="trigger-posttest-btn" class="control-btn action-btn">Post-Test</button>
    <button id="export-data-btn" class="control-btn action-btn">Export</button>
    <div class="control-separator"></div>
    <div class="control-item user-count-control">
      <span class="control-icon">&#128100;</span>
      <span id="admin-user-count">0</span>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app-screen">

    <!-- Chat Panel -->
    <div id="chat-panel">
      <div class="chat-header">
        <h2>Personal Workspace</h2>
        <div class="chat-header-actions">
          <button class="chat-header-btn" id="clear-workspace-btn" title="Clear workspace">Clear</button>
          <button class="leave-room-btn" id="leave-room-btn" title="Back to rooms">&larr; Rooms</button>
        </div>
      </div>
      <div class="chat-toggle" id="chat-toggle" title="Toggle chat">◀</div>

      <div class="chat-messages" id="chat-messages"></div>

      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea id="chat-input" placeholder="Explore a concept..." rows="1"></textarea>
          <button id="chat-send">Send</button>
          <button id="chat-cancel" class="chat-cancel-btn" style="display: none;">Cancel</button>
        </div>
      </div>
      <div class="chat-resize-handle" id="chat-resize-handle"></div>
    </div>

    <!-- Graph Area -->
    <div id="graph-area">
      <div class="room-bar">
        <div class="room-label" id="room-label">Room</div>
        <div class="room-timer" id="room-timer" style="display: none;">
          <span class="timer-icon">&#9201;</span>
          <span id="room-timer-text">--:--</span>
        </div>
        <div class="user-count" id="user-count">0 users</div>
        <div class="presence-dots" id="presence-dots"></div>
      </div>

      <div class="graph-toolbar">
        <button id="btn-fit-view" title="Fit view">⊞ Fit view</button>
        <button id="btn-auto-layout" title="Auto layout">⊟ Auto layout</button>
      </div>

      <svg id="graph-svg"></svg>

      <div class="connection-mode-banner" id="connection-banner">
        <span>Click a second node to connect</span>
        <span class="cancel-connect" id="cancel-connect">Cancel</span>
      </div>

      <div class="merge-mode-banner" id="merge-banner">
        <span>Click a second node to merge into</span>
        <span class="cancel-merge" id="cancel-merge">Cancel</span>
      </div>
    </div>

    <!-- Activity Panel -->
    <div id="activity-panel" class="collapsed">
      <div class="activity-toggle" id="activity-toggle" title="Toggle activity log">☰</div>
      <div class="activity-header">
        <h2>Activity</h2>
      </div>
      <div class="activity-list" id="activity-list"></div>
    </div>

  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="context-menu">
    <div class="context-menu-item" data-action="explore">
      <span class="cm-icon">&rarr;</span> Explore
    </div>
    <div class="context-menu-item" data-action="expand">
      <span class="cm-icon">↗</span> Expand (show related)
    </div>
    <div class="context-menu-item" data-action="suggest-connections">
      <span class="cm-icon">⚡</span> Suggest connections
    </div>
    <div class="context-menu-item" data-action="edit">
      <span class="cm-icon">&#9998;</span> Edit
    </div>
    <div class="context-menu-item" data-action="connect">
      <span class="cm-icon">⤫</span> Connect to...
    </div>
    <div class="context-menu-item" data-action="merge">
      <span class="cm-icon">⊕</span> Merge with...
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="upvote">
      <span class="cm-icon">△</span> Upvote
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item danger" data-action="prune">
      <span class="cm-icon">✕</span> Prune
    </div>
  </div>

  <!-- Edge Context Menu -->
  <div class="context-menu" id="edge-context-menu">
    <div class="context-menu-item" data-action="flip-direction">
      <span class="cm-icon">&#8634;</span> <span class="cm-label">Flip direction</span>
    </div>
    <div class="context-menu-item" data-action="toggle-directed">
      <span class="cm-icon">&#8596;</span> <span class="cm-label">Make symmetric</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item danger" data-action="delete-edge">
      <span class="cm-icon">&#10005;</span> <span class="cm-label">Delete connection</span>
    </div>
  </div>

  <!-- Feedback Button -->
  <button class="feedback-button" id="feedback-btn" title="Send feedback">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    Feedback
  </button>

  <!-- Feedback Modal -->
  <div class="modal-overlay" id="feedback-modal">
    <div class="modal-card feedback-modal">
      <h3>Feedback</h3>
      <button class="feedback-close" id="feedback-close">&times;</button>
      <label class="harvest-form-label">Category</label>
      <div class="feedback-categories" id="feedback-categories">
        <label><input type="radio" name="feedback-cat" value="bug"> Bug / something broken</label>
        <label><input type="radio" name="feedback-cat" value="suggestion"> Suggestion / feature idea</label>
        <label><input type="radio" name="feedback-cat" value="confusion"> Confusion / unclear how to...</label>
        <label><input type="radio" name="feedback-cat" value="general" checked> General comment</label>
      </div>
      <label class="harvest-form-label">What happened?</label>
      <textarea class="harvest-form-textarea" id="feedback-text" rows="4" placeholder="Tell us what's on your mind..."></textarea>
      <div class="modal-actions">
        <button id="feedback-submit" class="primary">Submit Feedback</button>
      </div>
    </div>
  </div>

  <!-- Similar Concepts Modal -->
  <div class="modal-overlay" id="similar-modal">
    <div class="modal-card">
      <h3>Similar concepts found</h3>
      <p id="similar-new-concept"></p>
      <div id="similar-list"></div>
      <div class="modal-actions">
        <button id="similar-add-anyway">Add anyway</button>
        <button id="similar-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Node Modal -->
  <div class="modal-overlay" id="edit-node-modal">
    <div class="modal-card">
      <h3>Edit concept</h3>
      <label class="harvest-form-label">Title</label>
      <input type="text" class="harvest-form-input" id="edit-node-title">
      <div class="edit-node-desc-header">
        <label class="harvest-form-label">Description</label>
        <button class="edit-node-generate-btn" id="edit-node-generate" title="Generate description with AI">&#10024; Generate</button>
      </div>
      <textarea class="harvest-form-textarea" id="edit-node-desc" rows="3"></textarea>
      <div class="modal-actions">
        <button id="edit-node-cancel">Cancel</button>
        <button id="edit-node-save" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Suggest Connections Modal -->
  <div class="modal-overlay" id="connections-modal">
    <div class="modal-card">
      <h3>Suggested connections</h3>
      <p id="connections-concept-name"></p>
      <div id="connections-list"></div>
      <div class="modal-actions">
        <button id="connections-skip">Skip</button>
        <button id="connections-add" class="primary" disabled>Add selected</button>
      </div>
    </div>
  </div>

  <!-- Concept Tooltip (F3) -->
  <div class="concept-tooltip" id="concept-tooltip">
    <strong class="concept-tooltip-title"></strong>
    <p class="concept-tooltip-desc"></p>
    <div class="concept-tooltip-actions">
      <button class="concept-tooltip-btn harvest" id="tooltip-harvest-btn">+ Harvest</button>
      <button class="concept-tooltip-btn explore" id="tooltip-explore-btn">→ Explore</button>
    </div>
  </div>

  <!-- Harvest Inline Form (F6) -->
  <div class="harvest-inline-form" id="harvest-inline-form">
    <label class="harvest-form-label">Title</label>
    <input type="text" class="harvest-form-input" id="harvest-form-title">
    <label class="harvest-form-label">Description</label>
    <textarea class="harvest-form-textarea" id="harvest-form-desc" rows="2"></textarea>
    <div class="harvest-form-actions">
      <button class="harvest-form-btn cancel" id="harvest-form-cancel">Cancel</button>
      <button class="harvest-form-btn submit" id="harvest-form-submit">Add to Graph →</button>
    </div>
  </div>

  <!-- Selection Toolbar (F5) -->
  <div class="selection-toolbar" id="selection-toolbar">
    <button class="selection-toolbar-btn harvest" id="selection-harvest-btn">+ Harvest</button>
    <button class="selection-toolbar-btn explore" id="selection-explore-btn">→ Explore</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/graph.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
